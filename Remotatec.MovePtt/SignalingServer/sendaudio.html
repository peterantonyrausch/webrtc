<!DOCTYPE html>
<head>
    <style>
        body {
            font-family: monospace;
        }
    </style>
    <script type="text/javascript">
        const WEBSOCKET_URL = "ws://127.0.0.1:8081/"

        var pc, ws;
        var wsConnected = false;

        async function start() {

            log("Conectando ao WebSocket...");

            ws = new WebSocket(document.querySelector('#websockurl').value, []);

            ws.onopen = function () {
                wsConnected = true;
                log("WebSocket conectado!");
            }

            ws.onmessage = async function (evt) {
                log("Mensagem recebida do WebSocket...");

                var obj = JSON.parse(evt.data);

                if (obj.action == "SDP") {
                    log("Recebendo offer...");

                    const localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });

                    pc = new RTCPeerConnection(null);

                    localStream.getTracks().forEach(track => {
                        console.log('add local track ' + track.kind + ' to peer connection.');
                        console.log(track);
                        pc.addTrack(track, localStream);
                    });

                    pc.onicegatheringstatechange = function () {
                        console.log("onicegatheringstatechange: " + pc.iceGatheringState);
                    }

                    pc.oniceconnectionstatechange = function () {
                        console.log("oniceconnectionstatechange: " + pc.iceConnectionState);
                    }

                    pc.onsignalingstatechange = function () {
                        console.log("onsignalingstatechange: " + pc.signalingState);
                    }

                    pc.onicecandidate = function (event) {
                        if (event.candidate) {
                            log("Enviando informações do ICE Candidate...");

                            ws.send(JSON.stringify({
                                action: "ICE_CANDIDATE",
                                payload: JSON.stringify({
                                    groupName: document.querySelector('#groupname').value,
                                    rtcInit: JSON.stringify(event.candidate)
                                })
                            }));
                        }
                    };

                    //pc.ontrack = evt => document.querySelector('#audioCtl').srcObject = evt.streams[0];

                    var payloadObj = JSON.parse(obj.payload);
                    var offerObj = JSON.parse(payloadObj.offer);

                    await pc.setRemoteDescription(new RTCSessionDescription(offerObj));

                    log("Criando answer...");

                    pc.createAnswer()
                        .then((answer) => pc.setLocalDescription(answer))
                        .then(() => {
                            log("Enviando answer...");
                            ws.send(JSON.stringify({
                                action: "SDP",
                                payload: JSON.stringify({
                                    groupName: document.querySelector('#groupname').value,
                                    rtcInit: JSON.stringify(pc.localDescription)
                                })
                            }))
                        });
                }
            };
        };

        lineNumber = 1;
        function log(message) {
            var html = document.querySelector('#log').innerHTML;
            document.querySelector('#log').innerHTML = html + "</br>" + lineNumber.toString().padStart(2, "0").padEnd(4," ") + message;
            lineNumber++;
        }

        async function connect() {
            log("Conectando no grupo...");

            let groupName = document.querySelector('#groupname').value;

            if (!groupName) {
                alert("Bota o nome do grupo seu zé ruela!");
                return;
            }

            if (!wsConnected) {
                alert("Espera o WebSocket conectar bixo!");
                return;
            }

            ws.send(JSON.stringify({
                action: "CONNECT_TO_GROUP",
                payload: groupName
            }));

            log("Mensagem de conexão enviada...");
        }

        async function closePeer() {
            if (ws != null) {
                console.log("closing web socket.");
                ws.close();
            }

            if (pc != null) {
                console.log("close peer");
                pc.close();
            }
        };

    </script>
</head>
<body>

    <!--<audio controls autoplay id="audioCtl"></audio>-->

    <div style="margin: 10px;">
        <input type="text" id="websockurl" size="40" />
        <button type="button" class="btn btn-success" onclick="start();">Connect WebSocket</button>
    </div>

    <div style="margin: 10px;">
        <input type="text" id="groupname" size="40" />
        <button type="button" class="btn btn-success" onclick="connect();">Connect Group</button>
    </div>

    <div style="margin: 10px;">
        <button type="button" class="btn btn-success" onclick="closePeer();">Disconnect</button>
    </div>
    
    <p id="log" style="margin: 10px;font-size:.9em;color:blue;"></p>
</body>

<script>
    document.querySelector('#websockurl').value = WEBSOCKET_URL;
</script>