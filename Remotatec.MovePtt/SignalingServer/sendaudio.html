<!DOCTYPE html>
<head>
    <script type="text/javascript">
        const WEBSOCKET_URL = "ws://127.0.0.1:8081/"

        var pc, ws;

        async function start() {

            const localStream = await navigator.mediaDevices.getUserMedia({ video: false, audio: true });

            ws = new WebSocket(document.querySelector('#websockurl').value, []);

            ws.onopen = function () {
                console.log("web socket onopen.");

                pc = new RTCPeerConnection(null);

                localStream.getTracks().forEach(track => {
                    console.log('add local track ' + track.kind + ' to peer connection.');
                    console.log(track);
                    pc.addTrack(track, localStream);
                });


                pc.onicegatheringstatechange = function () {
                    console.log("onicegatheringstatechange: " + pc.iceGatheringState);
                }

                pc.oniceconnectionstatechange = function () {
                    console.log("oniceconnectionstatechange: " + pc.iceConnectionState);
                }

                pc.onsignalingstatechange = function () {
                    console.log("onsignalingstatechange: " + pc.signalingState);
                }

                pc.onicecandidate = function (event) {
                    if (event.candidate) {
                        console.log('new-ice-candidate:');
                        console.log(event.candidate.candidate);
                        console.log(event.candidate);
                        ws.send(JSON.stringify(event.candidate));
                    }
                };

                //pc.ontrack = evt => document.querySelector('#audioCtl').srcObject = evt.streams[0];
            };

            ws.onmessage = async function (evt) {
                var obj = JSON.parse(evt.data);
                if (obj?.candidate) {
                    pc.addIceCandidate(obj);
                }
                else if (obj?.sdp) {
                    await pc.setRemoteDescription(new RTCSessionDescription(obj));
                    pc.createAnswer()
                        .then((answer) => pc.setLocalDescription(answer))
                        .then(() => ws.send(JSON.stringify(pc.localDescription)));
                }
            };
        };

        async function closePeer() {
            if (ws != null) {
                console.log("closing web socket.");
                ws.close();
            }

            if (pc != null) {
                console.log("close peer");
                pc.close();
            }
        };

    </script>
</head>
<body>

    <!--<audio controls autoplay id="audioCtl"></audio>-->

    <div>
        <input type="text" id="websockurl" size="40" />
        <button type="button" class="btn btn-success" onclick="start();">Start</button>
        <button type="button" class="btn btn-success" onclick="closePeer();">Close</button>
    </div>
</body>

<script>
    document.querySelector('#websockurl').value = WEBSOCKET_URL;
</script>